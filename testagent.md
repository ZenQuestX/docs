承知いたしました。他のAIエージェントにこの設計思想を正確に伝え、現在のプロジェクトに最適化された「実装計画」を出力させるための**「指示用プロンプト（要件定義書）」**を作成しました。

このままAI（ChatGPT, Claude, または自作のカスタムエージェント）に貼り付けてお使いいただけます。

---

# AIへの指示プロンプト：データ駆動型テスト（DDT）への移行とカスタムエージェント再設計

## 1. 背景と目的

現在、バックエンド（DBの読み書き、複数テーブルの複雑なJOINを伴うロジック）のテスト自動化を行っています。現在はカスタムエージェントを用いて「テストケース作成→コード作成→実行・修正」を自動化していますが、テストケースごとに関数が増大し、メンテナンス効率と実行速度に課題を感じています。

これを解決するため、**Pytestのパラメタライズ（`@pytest.mark.parametrize`）を活用した「データ駆動型テスト（DDT）」**に移行し、テストロジックとテストデータを分離する設計に再構築します。

## 2. 参照すべき設計骨子

以下の設計ガイドラインに基づき、現在のプロジェクトに当てはまる具体的な実装計画を作成してください。

### A. エージェントの役割分担（ワークフロー）

1. **ペルソナ会議エージェント**: 仕様・シナリオ（論理的ケース）の策定。
2. **データ変換エージェント**: シナリオを「DBのレコード状態（JSON/辞書形式）」に物理具体化。
3. **テストエンジン・エージェント**: 共通のテストロジック（データの自動投入・実行・検証）の実装。

### B. 技術的要件

* **JOINへの対応**: 複雑なJOINを検証するため、`setup_db` キーに複数のテーブル（users, orders, products等）の整合性が取れたデータを一括定義できる構造にすること。
* **検証の共通化**: 戻り値の比較だけでなく、実行後のDBの特定レコードの状態を検証する仕組みを共通関数に持たせること。
* **バグ修正フロー**: 新たなバグ発見時、関数を増やすのではなく、`SCENARIOS` リストにデータ行を1つ追加するだけで再現テストが完了する構成にすること。

## 3. 出力してほしい内容（計画書）

以下の項目を具体的に含めてください。

1. **ディレクトリ構成案**: テストコード、データファイル（JSON等）、共通フィクスチャをどこに配置すべきか。
2. **共通テストエンジンのテンプレートコード**:
* 複数テーブルに動的にデータをINSERTするヘルパー。
* パラメタライズを用いた共通テスト関数の実装例。


3. **各エージェント用のカスタムプロンプト案**:
* 「ペルソナ会議エージェント」が「データ変換エージェント」に渡すべきデータの仕様定義。
* 「実行・修正エージェント」がエラー時に「データの間違いか、ロジックのバグか」を判断するための判定基準。


4. **移行ステップ**: 現在の「関数量産型テスト」から、どのように段階的にDDTへ移行するか（特に複雑なJOINが絡む箇所から優先）。

---

### 補足：現在のプロジェクト状況

* 対象: バックエンドロジック
* 特徴: 複数テーブルのJOINを多用
* 技術スタック: Python, Pytest, (SQLAlchemy 等の利用状況に応じて適宜補足してください)

---

## ユーザー様へのアドバイス

上記のプロンプトを投げた際、AIから返ってきた内容に**「データの整合性をチェックするバリデータ」**（例：Pydantic等でのデータ定義）が含まれていなければ、追加で「AIが生成したテストデータのID不整合を防ぐ仕組みも考えて」と指示すると、より堅牢なシステムになります。

新しいカスタムエージェントの構築、応援しております！
