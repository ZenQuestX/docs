# FastAPIとSQLAlchemyを使用したネスト構造データの更新処理の実装

以下の要件に基づいて、FastAPIとSQLAlchemyを使用したデータの更新処理を実装してください：

## 要件:
1. 単一のエンドポイントで更新処理を行う
2. フラットな（ネストのない）シンプルなJSONを受け取る
3. Pydanticモデルは可能な限り1つで実装する
4. ORMは複数階層（3階層程度）のリレーションを持つ
5. 更新・追加・削除の全処理に対応する

## データ構造:
- 階層1 (例: GrandParent) → 階層2 (例: Parent) → 階層3 (例: Child) というリレーション構造
- データ取得時にはネストされたJSONが出力される

## 実装すべき機能:
- 最上位エンティティ（例：GrandParent）の更新
- 中間エンティティ（例：Parent）の更新、追加、削除
- 最下位エンティティ（例：Child）の更新、追加、削除
- 各階層間の整合性チェック
- トランザクション処理

## 具体的な更新JSONの形式例:
```json
{
  "grandparent_id": 1,
  "grandparent_name": "更新後の名前",
  "update_parents": [{"id": 1, "name": "更新後の親の名前"}],
  "delete_parent_ids": [2],
  "add_parents": [{"name": "新しい親"}],
  "update_children": [{"id": 1, "name": "更新後の子の名前", "age": 10, "parent_id": 1}],
  "delete_child_ids": [2],
  "add_children": [{"name": "新しい子", "age": 5, "parent_id": 1}]
}
```

## 考慮すべき点:
- リレーションの整合性を維持する
- 適切なバリデーションとエラーハンドリング
- トランザクションの一貫性を確保
- パフォーマンスを考慮した実装

フラットなJSONを使いつつ、複雑なリレーション構造を効率的に更新できるコードを実装してください。
